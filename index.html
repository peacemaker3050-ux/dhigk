<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>University Library Bot (Hybrid Control)</title>
    
    <style>
        /* === Reset & Basic Settings === */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #121212;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-color: #0f0f0f;
            --header-bg: #17212b;
            --chat-bg: #0e1621;
            --msg-in: #182533;
            --msg-out: #2b5278;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-color: #3390ec;
            --btn-bg: rgba(255, 255, 255, 0.05);
            --btn-hover: rgba(51, 144, 236, 0.15);
            --btn-border: rgba(255, 255, 255, 0.1);
            --file-dummy-bg: rgba(255, 85, 85, 0.1);
            --file-dummy-text: #ff8888;
            --menu-bg: #1d2938;
            --modal-bg: rgba(0, 0, 0, 0.9);
            --admin-tab-active: #3390ec;
            --admin-tab-inactive: #2b2b2b;
            --danger-color: #ff4444;
        }

        * { box-sizing: border-box; outline: none; }

        /* === Main Container === */
        .app-container {
            width: 100%;
            max-width: 500px; 
            height: 100%; 
            margin: 0 auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* === Header === */
        header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #000;
            z-index: 20; flex-shrink: 0; user-select: none;
        }

        .header-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        
        .bot-avatar {
            width: 42px; height: 42px; border-radius: 50%;
            background-color: var(--accent-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; flex-shrink: 0;
            background-size: cover; background-position: center;
            background-repeat: no-repeat; border: 2px solid transparent; color: #fff;
        }

        .bot-name h2 { font-size: 16px; margin: 0; font-weight: 600; line-height: 1.2; }
        .bot-status { font-size: 13px; color: var(--text-secondary); margin-top: 2px; display: block; }

        .header-actions { color: var(--text-secondary); font-size: 28px; line-height:1; padding: 5px 10px; cursor: pointer; user-select: none; }
        .header-actions:hover { color: #fff; }

        /* === Options Menu (Dropdown) === */
        .menu-dropdown {
            position: absolute; top: 60px; right: 10px;
            width: 220px; background-color: var(--menu-bg);
            border: 1px solid #000; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; flex-direction: column; z-index: 100;
            overflow: hidden; animation: fadeIn 0.2s ease;
        }
        .menu-dropdown.active { display: flex; }
        .menu-item { padding: 12px 15px; cursor: pointer; color: #fff; font-size: 14px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background-color: rgba(255,255,255,0.1); }
        .menu-item.danger { color: #ff6b6b; }
        .menu-item.admin { color: #4dabf7; font-weight: bold; }
        .menu-item.refresh { color: #ffcc00; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* === Admin Modal === */
        .admin-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg); backdrop-filter: blur(8px);
            z-index: 200; display: none; flex-direction: column;
            padding: 20px; overflow-y: auto;
        }
        .admin-modal.active { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .modal-title { font-size: 18px; font-weight: bold; color: #fff; }
        .close-modal { font-size: 28px; color: #ccc; cursor: pointer; line-height: 1; }
        .close-modal:hover { color: #fff; }

        /* Admin Tabs */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; background: var(--admin-tab-inactive); border: none;
            color: #aaa; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .tab-btn.active { background: var(--admin-tab-active); color: #fff; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
        .form-input, .form-textarea {
            width: 100%; padding: 10px; background: rgba(255,255,255,0.08); border: 1px solid #444;
            border-radius: 6px; color: #fff; outline: none; font-family: inherit; transition: border 0.2s;
        }
        .form-textarea { height: 60px; resize: vertical; }
        .form-input:focus, .form-textarea:focus { border-color: var(--accent-color); background: rgba(255,255,255,0.12); }
        
        .admin-section-title {
            color: var(--accent-color); margin-top: 20px; margin-bottom: 10px;
            font-size: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .btn-save {
            width: 100%; padding: 12px; background-color: var(--accent-color);
            color: #fff; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 20px; transition: background 0.2s;
        }
        .btn-save:hover { background-color: #267fd3; }

        /* Data Management Styles */
        .data-path { font-size: 12px; color: #888; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .data-path span { cursor: pointer; }
        .data-path span:hover { text-decoration: underline; color: var(--accent-color); }
        
        .data-list { display: flex; flex-direction: column; gap: 8px; max-height: 50vh; overflow-y: auto; margin-bottom: 15px; }
        .data-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
        }
        .data-item:hover { background: rgba(255,255,255,0.1); }
        .data-name { cursor: pointer; flex: 1; font-weight: 500; }
        .data-actions { display: flex; gap: 8px; }
        .btn-sm { padding: 4px 8px; border-radius: 4px; border: none; font-size: 12px; cursor: pointer; font-weight: bold; }
        .btn-del { background: rgba(255, 68, 68, 0.2); color: var(--danger-color); }
        .btn-del:hover { background: var(--danger-color); color: #fff; }

        .add-box { background: rgba(51, 144, 236, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(51, 144, 236, 0.3); }
        .add-row { display: flex; gap: 5px; margin-top: 8px; }
        .btn-add { background: #28a745; color: #fff; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        .btn-add:hover { background: #218838; }

        /* === Chat Area === */
        #chat-area {
            flex: 1; padding: 15px; overflow-y: auto; display: flex;
            flex-direction: column; gap: 12px;
            background-color: var(--chat-bg);
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px; scroll-behavior: smooth;
        }
        #chat-area::-webkit-scrollbar { width: 5px; }
        #chat-area::-webkit-scrollbar-track { background: transparent; }
        #chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* === Messages === */
        .message {
            width: fit-content; max-width: 90%; padding: 10px 14px;
            border-radius: 18px; position: relative; font-size: 15px;
            line-height: 1.5; word-wrap: break-word;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .msg-bot { align-self: flex-start; background-color: var(--msg-in); color: var(--text-primary); border-bottom-left-radius: 4px; } 
        .msg-user { align-self: flex-end; background-color: var(--msg-out); color: var(--text-primary); border-bottom-right-radius: 4px; } 
        .msg-bot b { color: #fff; font-weight: 700; }
        .timestamp { font-size: 10px; color: rgba(255,255,255,0.4); text-align: right; display: block; margin-top: 6px; margin-bottom: 0; float: none; clear: both; user-select: none; }

        /* === File Attachments === */
        .file-link-btn {
            display: flex; align-items: center; gap: 10px;
            background-color: rgba(0,0,0,0.2); padding: 10px;
            border-radius: 8px; text-decoration: none; color: var(--accent-color);
            margin-top: 5px; border: 1px solid rgba(51, 144, 236, 0.3);
            font-size: 14px; cursor: pointer; transition: background 0.2s; overflow-wrap: break-word;
        }
        .file-link-btn:hover { background-color: rgba(51, 144, 236, 0.15); }
        .file-link-dummy {
            display: flex; align-items: center; gap: 10px;
            background-color: var(--file-dummy-bg); padding: 10px;
            border-radius: 8px; color: var(--file-dummy-text);
            margin-top: 5px; border: 1px solid rgba(255, 85, 85, 0.3);
            font-size: 14px;
        }

        /* === Typing Indicator === */
        .typing-indicator { font-size: 12px; color: var(--text-secondary); margin-left: 15px; margin-bottom: 10px; display: none; font-style: italic; opacity: 0.8; flex-shrink: 0; } 
        .typing-indicator.active { display: block; }

        /* === Keyboard Area === */
        #keyboard-area {
            background-color: var(--header-bg); padding: 10px;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
            border-top: 1px solid #000; min-height: 0; max-height: 45vh;
            overflow-y: auto; flex-shrink: 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .keyboard-btn {
            background-color: var(--btn-bg); border: 1px solid var(--btn-border);
            color: var(--text-primary); padding: 12px 8px; border-radius: 10px;
            cursor: pointer; transition: all 0.15s ease; font-size: 14px;
            user-select: none; white-space: normal; word-wrap: break-word;
            word-break: break-word; text-align: center; line-height: 1.3;
            position: relative; overflow: hidden; min-height: 50px;
            display: flex; align-items: center; justify-content: center; font-weight: 500;
        }
        .keyboard-btn:hover { background-color: var(--btn-hover); }
        .keyboard-btn:active { transform: scale(0.96); background-color: rgba(255,255,255,0.15); }
        .keyboard-btn.back-btn {
            grid-column: span 2; background-color: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.05); color: var(--text-secondary); font-weight: bold;
        }
        @media (max-width: 480px) { .keyboard-btn { font-size: 13px; padding: 12px 6px; line-height: 1.4; min-height: 48px; } }
        @media (max-width: 350px) { #keyboard-area { grid-template-columns: 1fr; } .keyboard-btn.back-btn { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-info">
            <div class="bot-avatar" id="header-avatar">ğŸ“</div>
            <div class="bot-name">
                <h2 id="header-name">University Bot</h2>
                <span class="bot-status" id="header-status">Online</span>
            </div>
        </div>
        
        <div class="header-actions" id="menu-btn" title="Menu">â‹®</div>

        <div class="menu-dropdown" id="menu-dropdown">
            <div class="menu-item refresh" onclick="window.forceReload()">
                <span>ğŸ”„</span> <span>ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ø±ÙŠ (Fix Cache)</span>
            </div>
            <div class="menu-item admin" onclick="window.checkAdmin()">
                <span>âš™ï¸</span> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin)</span>
            </div>
            <div class="menu-item" onclick="window.clearChat()">
                <span>ğŸ—‘ï¸</span> <span>Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª</span>
            </div>
            <div class="menu-item danger" onclick="window.resetBot()">
                <span>ğŸ </span> <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
            </div>
        </div>
    </header>

    <div id="chat-area"></div>
    <div class="typing-indicator" id="typing">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
    <div id="keyboard-area"></div>
</div>

<!-- Admin Modal -->
<div class="admin-modal" id="admin-modal">
    <div class="modal-header">
        <div class="modal-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª</div>
        <div class="close-modal" onclick="window.closeAdminPanel()">Ã—</div>
    </div>

    <!-- Tabs Navigation -->
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="window.switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</button>
        <button class="tab-btn" onclick="window.switchTab('data')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <!-- Tab 1: General Settings -->
    <div id="tab-settings" class="tab-content active">
        <div class="admin-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª</label><input type="text" id="admin-bot-name" class="form-input"></div>
        <div class="form-group"><label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><input type="text" id="admin-bot-status" class="form-input"></div>
        <div class="form-group"><label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)</label><input type="text" id="admin-bot-img" class="form-input"></div>

        <div class="form-group"><label class="form-label">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨</label><textarea id="admin-msg-welcome" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø©</label><textarea id="admin-msg-subject" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙƒØªÙˆØ±</label><textarea id="admin-msg-doctor" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</label><textarea id="admin-msg-category" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†ØµÙˆØµ Ø§Ù„Ø¹ÙˆØ¯Ø© (Back)</label><textarea id="admin-msg-backs" class="form-textarea" placeholder="Back Subject | Back Doctor | Back Main"></textarea></div>

        <div class="admin-section-title">Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
        <div class="form-group">
            <label class="form-label">Ø¥Ø¶Ø§ÙØ© Admin</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="admin-add-input" class="form-input">
                <button class="btn-save" style="width: auto; margin: 0; padding: 0 15px;" onclick="window.addAdmin()">+</button>
            </div>
        </div>
        <div class="admin-list" id="admin-list-container"></div>

        <button class="btn-save" onclick="window.saveAdminSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <!-- Tab 2: Data Management -->
    <div id="tab-data" class="tab-content">
        <div class="data-path" id="admin-data-path">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        
        <div id="admin-data-view-container">
            <!-- Dynamic Content Here -->
            <div class="data-list" id="admin-list-items"></div>
            
            <div class="add-box" id="admin-add-box">
                <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
                <div class="form-group" style="margin-bottom:5px;">
                    <input type="text" id="new-item-name" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…...">
                </div>
                <div class="form-group" style="margin-bottom:0;" id="file-link-input-group" style="display:none;">
                    <input type="text" id="new-item-link" class="form-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù (Link)...">
                </div>
                <div class="add-row">
                    <button class="btn-save" style="margin-top:5px; padding:8px;" onclick="window.addAdminDataItem()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // === 1. CONFIGURATION & DEFAULTS ===
    // ============================================================
    const JSONBIN_BIN_ID = "696e77bfae596e708fe71e9d";
    const JSONBIN_ACCESS_KEY = "$2a$10$TunKuA35QdJp478eIMXxRunQfqgmhDY3YAxBXUXuV/JrgIFhU0Lf2";

    // Default Database Structure (Edit this in HTML code!)
    const defaultDatabase = {
        "Physics": {
            "doctors": ["Dr. Ahmed", "Dr. Mahmoud"],
            "Dr. Ahmed": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Chapter 1: Mechanics Basics.pdf", link: "https://drive.google.com/file/d/1_iodAsHFokkB3rTyGls5hSGET9XuvtWM/view?usp=drivesdk" },
                    { name: "Chapter 2: Motion in One Dimension.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 3: Vectors.pdf", link: "javascript:void(0)" },
                    { name: "Chapter 4: Motion in Two Dimensions.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Mahmoud": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                     { name: "Lecture 1: Thermodynamics Intro.pdf", link: "javascript:void(0)" },
                     { name: "Lecture 2: Heat Transfer.pdf", link: "javascript:void(0)" },
                     { name: "Lecture 3: Kinetic Theory.pdf", link: "javascript:void(0)" },
                     { name: "Lecture 4: First Law of Thermodynamics.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Chemistry": {
            "doctors": ["Dr. Saeed", "Dr. Mona"],
            "Dr. Saeed": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Unit 1: Atomic Structure.pdf", link: "javascript:void(0)" },
                    { name: "Unit 2: Chemical Bonding.pdf", link: "javascript:void(0)" },
                    { name: "Unit 3: Periodic Table.pdf", link: "javascript:void(0)" },
                    { name: "Unit 4: States of Matter.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Mona": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                     { name: "Analytical Chem: Volumetric Analysis.pdf", link: "javascript:void(0)" },
                     { name: "Analytical Chem: Gravimetric Analysis.pdf", link: "javascript:void(0)" },
                     { name: "Qualitative Analysis Flowcharts.pdf", link: "javascript:void(0)" },
                     { name: "Lab Safety Rules.pdf", link: "javascript:void(0)" }
                ]
            }
        },
        "Mathematics": {
            "doctors": ["Dr. Kamel", "Dr. Samy"],
            "Dr. Kamel": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Calculus I: Limits & Continuity.pdf", link: "javascript:void(0)" },
                    { name: "Calculus II: Differentiation Rules.pdf", link: "javascript:void(0)" },
                    { name: "Calculus III: Applications of Derivatives.pdf", link: "javascript:void(0)" },
                    { name: "Integration Techniques.pdf", link: "javascript:void(0)" }
                ]
            },
            "Dr. Samy": {
                "sections": ["ğŸ“š Lectures"],
                "ğŸ“š Lectures": [
                    { name: "Linear Algebra: Matrices.pdf", link: "javascript:void(0)" },
                    { name: "Differential Equations.pdf", link: "javascript:void(0)" },
                    { name: "Geometry: Vectors in 3D.pdf", link: "javascript:void(0)" },
                    { name: "Complex Numbers Problems.pdf", link: "javascript:void(0)" }
                ]
            }
        }
    };

    const defaultConfig = {
        botName: "University Library",
        botStatus: "Online",
        botIcon: "ğŸ“", 
        botImage: "", 
        typingSpeed: 600, 
        admins: ["owner"],
        welcomeMessage: "Welcome! ğŸ“<br>This is <b>{botName}</b>.<br>Please select a subject to begin.",
        subjectPrompt: "<b>{name}</b>\nPlease select a Doctor ğŸ‘‡",
        doctorPrompt: "<b>{name}</b>\nSelect a section ğŸ‘‡",
        categoryPrompt: "<b>{name}</b> list:",
        backSubject: "Back to <b>{name}</b> doctors:",
        backDoctor: "Back to <b>{name}</b> sections:",
        backMain: "Back to Main Menu.",
        database: defaultDatabase
    };

    let CONFIG = { ...defaultConfig };
    let database = CONFIG.database; 
    let refreshInterval = null;

    // ============================================================
    // === 2. SYNC LOGIC (Hybrid Control) ===
    // ============================================================
    function startSync() {
        if(refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(fetchConfig, 15000);
    }

    function stopSync() {
        if(refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    function fetchConfig() {
        if (!JSONBIN_BIN_ID || JSONBIN_BIN_ID === "PUT_YOUR_BIN_ID_HERE") {
            applyConfig(CONFIG); return;
        }
        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { 'X-Master-Key': JSONBIN_ACCESS_KEY, 'X-Bin-Meta': 'false' }
        })
        .then(res => { if (!res.ok) throw new Error("Failed"); return res.json(); })
        .then(data => { 
            // Apply general settings from Bin
            CONFIG = { ...defaultConfig, ...data }; 
            
            // HYBRID MERGE LOGIC:
            // We want HTML (defaultDatabase) to be the MASTER for existing items.
            // We want Admin Panel (Bin) to ADD new items that are not in HTML.
            // We reverse the spread order for 'database' only.
            // 1. Start with Bin data (Admin additions).
            // 2. Overwrite/Extend with HTML data (Your Code).
            if (data.database) {
                CONFIG.database = { ...data.database, ...defaultDatabase };
            } else {
                CONFIG.database = defaultDatabase;
            }
            
            applyConfig(CONFIG); 
        })
        .catch(err => { console.error("Sync Error:", err); });
    }

    function saveConfigToBin(newConfig) {
        if (!JSONBIN_BIN_ID || JSONBIN_BIN_ID === "PUT_YOUR_BIN_ID_HERE") { alert("âŒ Bin ID Ù…ÙÙ‚ÙˆØ¯!"); return; }
        
        const btnSave = document.querySelector('.btn-save');
        if(btnSave) btnSave.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_ACCESS_KEY },
            body: JSON.stringify(newConfig)
        })
        .then(res => { if (!res.ok) throw new Error("Save failed"); 
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
            // Update local database immediately to reflect Admin changes
            database = newConfig.database;
            // Re-apply HTML logic immediately after saving to keep view consistent
            CONFIG.database = { ...newConfig.database, ...defaultDatabase };
            database = CONFIG.database;

            if(btnSave) btnSave.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª";
            window.closeAdminPanel();
        })
        .catch(err => { alert("âŒ Ø®Ø·Ø£: " + err.message); if(btnSave) btnSave.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"; });
    }

    function applyConfig(newConfig) {
        CONFIG = newConfig;
        database = CONFIG.database; 
        document.getElementById('header-name').innerText = CONFIG.botName;
        document.getElementById('header-status').innerText = CONFIG.botStatus;
        const avatarEl = document.getElementById('header-avatar');
        if (CONFIG.botImage && CONFIG.botImage.trim() !== "") {
            avatarEl.style.backgroundImage = `url('${CONFIG.botImage}')`; avatarEl.innerText = ""; 
        } else {
            avatarEl.style.backgroundImage = "none"; avatarEl.innerText = CONFIG.botIcon;
        }
        // Force re-render keyboard to show changes
        renderKeyboard();
    }

    function replacePlaceholders(text, name) {
        let res = text || "";
        if (name) res = res.replace(/{name}/g, name);
        res = res.replace(/{botName}/g, CONFIG.botName);
        return res;
    }

    // ============================================================
    // === 3. BOT LOGIC ===
    // ============================================================
    let currentSubject = null, currentDoctor = null, currentCategory = null;
    const chatArea = document.getElementById('chat-area');
    const keyboardArea = document.getElementById('keyboard-area');
    const typingIndicator = document.getElementById('typing');
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    const adminNameInput = document.getElementById('admin-bot-name');
    const adminStatusInput = document.getElementById('admin-bot-status');
    const adminImgInput = document.getElementById('admin-bot-img');
    const adminAddInput = document.getElementById('admin-add-input');
    const adminListContainer = document.getElementById('admin-list-container');
    const respWelcome = document.getElementById('admin-msg-welcome');
    const respSubject = document.getElementById('admin-msg-subject');
    const respDoctor = document.getElementById('admin-msg-doctor');
    const respCategory = document.getElementById('admin-msg-category');
    const respBacks = document.getElementById('admin-msg-backs');

    function addMessage(content, sender, isHtml = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender === 'bot' ? 'msg-bot' : 'msg-user');
        if (isHtml) msgDiv.innerHTML = content; else msgDiv.innerText = content;
        const timeSpan = document.createElement('span');
        timeSpan.classList.add('timestamp');
        timeSpan.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        msgDiv.appendChild(timeSpan);
        chatArea.appendChild(msgDiv);
        scrollToBottom();
    }

    function scrollToBottom() { setTimeout(() => { chatArea.scrollTop = chatArea.scrollHeight; }, 0); }
    function botReply(text, isHtml = false) {
        typingIndicator.classList.add('active'); scrollToBottom();
        setTimeout(() => { typingIndicator.classList.remove('active'); addMessage(text, 'bot', isHtml); }, CONFIG.typingSpeed);
    }

    function createButton(text, onClick, isBack = false) {
        const btn = document.createElement('div');
        btn.classList.add('keyboard-btn'); if(isBack) btn.classList.add('back-btn');
        btn.innerText = text; btn.onclick = onClick; return btn;
    }

    menuBtn.addEventListener('click', (e) => { e.stopPropagation(); menuDropdown.classList.toggle('active'); });
    document.addEventListener('click', (e) => { if (!menuDropdown.contains(e.target) && e.target !== menuBtn) menuDropdown.classList.remove('active'); });

    window.clearChat = function() {
        chatArea.innerHTML = ''; resetStateVariables(); menuDropdown.classList.remove('active');
        setTimeout(() => { botReply("Chat cleared. ğŸ§¹<br>Welcome back! Choose a subject ğŸ‘‡", true); }, 100);
    }
    window.resetBot = function() {
        resetStateVariables(); menuDropdown.classList.remove('active');
        addMessage("ğŸ  Back to Main Menu", 'user'); botReply("Bot restarted. Please select a subject ğŸ‘‡", true);
    }

    window.checkAdmin = function() {
        menuDropdown.classList.remove('active');
        const password = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
        if (password === "1234") openAdminPanel();
        else if (password !== null) alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
    }

    // ============================================================
    // === 4. ADMIN PANEL LOGIC ===
    // ============================================================
    let adminNavStack = [];

    function openAdminPanel() {
        stopSync();
        adminNameInput.value = CONFIG.botName; adminStatusInput.value = CONFIG.botStatus;
        adminImgInput.value = CONFIG.botImage || ""; respWelcome.value = CONFIG.welcomeMessage;
        respSubject.value = CONFIG.subjectPrompt; respDoctor.value = CONFIG.doctorPrompt;
        respCategory.value = CONFIG.categoryPrompt;
        
        const backs = [CONFIG.backSubject, CONFIG.backDoctor, CONFIG.backMain];
        respBacks.value = backs.join(' | ');

        renderAdminList(); 
        renderAdminDataView(); 
        document.getElementById('admin-modal').classList.add('active');
    }

    window.closeAdminPanel = function() { 
        document.getElementById('admin-modal').classList.remove('active'); 
        startSync();
        // Ensure UI updates immediately upon closing
        fetchConfig();
    }
    
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if(tabName === 'settings') {
            document.querySelector('button[onclick="window.switchTab(\'settings\')"]').classList.add('active');
            document.getElementById('tab-settings').classList.add('active');
        } else {
            document.querySelector('button[onclick="window.switchTab(\'data\')"]').classList.add('active');
            document.getElementById('tab-data').classList.add('active');
            renderAdminDataView();
        }
    }

    function renderAdminList() {
        adminListContainer.innerHTML = '';
        if (!CONFIG.admins || CONFIG.admins.length === 0) { adminListContainer.innerHTML = '<div style="color:#777; font-size:13px;">No admins added yet.</div>'; return; }
        CONFIG.admins.forEach((admin, index) => {
            const div = document.createElement('div'); div.className = 'admin-item';
            const nameSpan = document.createElement('span'); nameSpan.className = 'admin-name'; nameSpan.innerText = admin;
            if (admin !== 'owner') {
                const removeBtn = document.createElement('button'); removeBtn.className = 'btn-remove'; removeBtn.innerText = 'Ø­Ø°Ù'; removeBtn.onclick = () => removeAdmin(index);
                div.appendChild(nameSpan); div.appendChild(removeBtn);
            } else { div.appendChild(nameSpan); div.innerHTML += '<span style="color:#4dabf7; font-size:12px;"> (Owner)</span>'; }
            adminListContainer.appendChild(div);
        });
    }

    window.addAdmin = function() {
        const name = adminAddInput.value.trim();
        if (name) { if (!CONFIG.admins) CONFIG.admins = []; if (!CONFIG.admins.includes(name)) { CONFIG.admins.push(name); adminAddInput.value = ''; renderAdminList(); } else alert("Admin already exists!"); }
    }
    window.removeAdmin = function(index) { if (confirm("Are you sure?")) { CONFIG.admins.splice(index, 1); renderAdminList(); } }

    window.saveAdminSettings = function() {
        const backsArr = respBacks.value.split('|').map(s => s.trim());
        
        const newConfig = {
            botName: adminNameInput.value.trim() || defaultConfig.botName,
            botStatus: adminStatusInput.value.trim() || defaultConfig.botStatus,
            botImage: adminImgInput.value.trim(),
            welcomeMessage: respWelcome.value, subjectPrompt: respSubject.value,
            doctorPrompt: respDoctor.value, categoryPrompt: respCategory.value,
            backSubject: backsArr[0] || CONFIG.backSubject,
            backDoctor: backsArr[1] || CONFIG.backDoctor,
            backMain: backsArr[2] || CONFIG.backMain,
            admins: CONFIG.admins,
            database: database 
        };
        CONFIG = { ...CONFIG, ...newConfig }; applyConfig(CONFIG); saveConfigToBin(newConfig);
    }

    // === DATA MANAGEMENT LOGIC ===

    function renderAdminDataView() {
        const pathContainer = document.getElementById('admin-data-path');
        const listContainer = document.getElementById('admin-list-items');
        const addBoxNameInput = document.getElementById('new-item-name');
        const addBoxLinkGroup = document.getElementById('file-link-input-group');
        const addBoxLinkInput = document.getElementById('new-item-link');

        listContainer.innerHTML = '';
        addBoxNameInput.value = '';
        addBoxLinkInput.value = '';
        addBoxNameInput.placeholder = "Ø§Ù„Ø§Ø³Ù…...";

        // Breadcrumb
        let pathHTML = `<span onclick="window.adminNavTo(-1)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;
        if (adminNavStack.length > 0) pathHTML += ` > <span onclick="window.adminNavTo(0)">${adminNavStack[0]}</span>`;
        if (adminNavStack.length > 1) pathHTML += ` > <span onclick="window.adminNavTo(1)">${adminNavStack[1]}</span>`;
        if (adminNavStack.length > 2) pathHTML += ` > <span>${adminNavStack[2]}</span>`;
        pathContainer.innerHTML = pathHTML;

        let level = adminNavStack.length;
        let dataList = [];

        if (level === 0) {
            dataList = Object.keys(database);
            addBoxLinkGroup.style.display = 'none';
        } 
        else if (level === 1) {
            const subName = adminNavStack[0];
            if (database[subName] && database[subName].doctors) {
                dataList = database[subName].doctors;
            }
            addBoxLinkGroup.style.display = 'none';
        } 
        else if (level === 2) {
            const subName = adminNavStack[0];
            const docName = adminNavStack[1];
            if (database[subName] && database[subName][docName] && database[subName][docName].sections) {
                dataList = database[subName][docName].sections;
            }
            addBoxLinkGroup.style.display = 'none';
        } 
        else if (level === 3) {
            const subName = adminNavStack[0];
            const docName = adminNavStack[1];
            const secName = adminNavStack[2];
            if (database[subName] && database[subName][docName] && database[subName][docName][secName]) {
                dataList = database[subName][docName][secName];
            }
            addBoxLinkGroup.style.display = 'block';
            addBoxNameInput.placeholder = "Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù...";
        }

        // Render Items
        if (dataList.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</div>';
        } else {
            dataList.forEach((item, index) => {
                const itemName = (typeof item === 'object') ? item.name : item;
                
                const div = document.createElement('div');
                div.className = 'data-item';
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'data-name';
                nameSpan.innerText = itemName;
                if (level < 3) {
                    nameSpan.onclick = () => {
                        adminNavStack.push(itemName);
                        renderAdminDataView();
                    };
                }

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'data-actions';
                
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-sm btn-del';
                delBtn.innerText = 'ğŸ—‘ï¸';
                delBtn.onclick = () => deleteAdminDataItem(index);

                actionsDiv.appendChild(delBtn);
                div.appendChild(nameSpan);
                div.appendChild(actionsDiv);
                listContainer.appendChild(div);
            });
        }
    }

    window.adminNavTo = function(index) {
        if (index === -1) adminNavStack = [];
        else {
            adminNavStack = adminNavStack.slice(0, index + 1);
        }
        renderAdminDataView();
    }

    window.addAdminDataItem = function() {
        const nameInput = document.getElementById('new-item-name');
        const linkInput = document.getElementById('new-item-link');
        const name = nameInput.value.trim();
        let level = adminNavStack.length;

        if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");

        if (level === 0) {
            if (database[name]) return alert("Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!");
            database[name] = { doctors: [] };
        } 
        else if (level === 1) {
            const sub = adminNavStack[0];
            if (!database[sub]) database[sub] = { doctors: [] };
            if (database[sub].doctors.includes(name)) return alert("Ø§Ù„Ø¯ÙƒØªÙˆØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
            
            database[sub].doctors.push(name);
            database[sub][name] = { sections: [] }; 
        } 
        else if (level === 2) {
            const sub = adminNavStack[0];
            const doc = adminNavStack[1];
            if (!database[sub][doc]) database[sub][doc] = { sections: [] };
            if (database[sub][doc].sections.includes(name)) return alert("Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");

            database[sub][doc].sections.push(name);
            database[sub][doc][name] = []; 
        } 
        else if (level === 3) {
            const sub = adminNavStack[0];
            const doc = adminNavStack[1];
            const sec = adminNavStack[2];
            const link = linkInput.value.trim() || "#";

            if (!database[sub][doc][sec]) database[sub][doc][sec] = [];
            database[sub][doc][sec].push({ name: name, link: link });
        }

        renderAdminDataView();
    }

    function deleteAdminDataItem(index) {
        let level = adminNavStack.length;

        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;

        if (level === 0) {
            const subKeys = Object.keys(database);
            const subToDelete = subKeys[index];
            delete database[subToDelete];
        } 
        else if (level === 1) {
            const sub = adminNavStack[0];
            const docName = database[sub].doctors[index];
            database[sub].doctors.splice(index, 1);
            delete database[sub][docName];
        } 
        else if (level === 2) {
            const sub = adminNavStack[0];
            const doc = adminNavStack[1];
            const secName = database[sub][doc].sections[index];
            database[sub][doc].sections.splice(index, 1);
            delete database[sub][doc][secName];
        } 
        else if (level === 3) {
            const sub = adminNavStack[0];
            const doc = adminNavStack[1];
            const sec = adminNavStack[2];
            database[sub][doc][sec].splice(index, 1);
        }
        renderAdminDataView();
    }

    // ============================================================
    // === 5. KEYBOARD RENDERER ===
    // ============================================================
    function resetStateVariables() { currentSubject = null; currentDoctor = null; currentCategory = null; renderKeyboard(); }

    function renderKeyboard() {
        keyboardArea.innerHTML = '';
        const subjects = Object.keys(database);
        
        if (!currentSubject) { 
            subjects.forEach(sub => { keyboardArea.appendChild(createButton(sub, () => handleSubjectClick(sub))); }); 
            return; 
        }
        
        keyboardArea.appendChild(createButton("ğŸ”™ Back", goBack, true));
        if (currentSubject && !currentDoctor) {
            const subjectDoctors = database[currentSubject].doctors;
            subjectDoctors.forEach(doc => { keyboardArea.appendChild(createButton(doc, () => handleDoctorClick(doc))); });
        } else if (currentSubject && currentDoctor && !currentCategory) {
            const doctorSections = database[currentSubject][currentDoctor].sections;
            doctorSections.forEach(cat => { keyboardArea.appendChild(createButton(cat, () => handleCategoryClick(cat))); });
        } else if (currentSubject && currentDoctor && currentCategory) {
            const fileList = database[currentSubject][currentDoctor][currentCategory] || [];
            if (fileList.length > 0) { fileList.forEach(file => { keyboardArea.appendChild(createButton(file.name, () => handleFileClick(file))); }); } else {
                const emptyBtn = createButton("âŒ No files available", () => {}); emptyBtn.style.opacity = "0.5"; emptyBtn.style.cursor = "default"; keyboardArea.appendChild(emptyBtn);
            }
        }
    }

    function handleSubjectClick(subjectName) { addMessage(subjectName, 'user'); currentSubject = subjectName; currentDoctor = null; currentCategory = null; const msg = replacePlaceholders(CONFIG.subjectPrompt, subjectName); botReply(msg, true); renderKeyboard(); }
    function handleDoctorClick(doctorName) { addMessage(doctorName, 'user'); currentDoctor = doctorName; currentCategory = null; const msg = replacePlaceholders(CONFIG.doctorPrompt, doctorName); botReply(msg, true); renderKeyboard(); }
    function handleCategoryClick(categoryName) { addMessage(categoryName, 'user'); currentCategory = categoryName; const msg = replacePlaceholders(CONFIG.categoryPrompt, categoryName); botReply(msg, true); renderKeyboard(); }
    function handleFileClick(fileObj) {
        addMessage(`Open: ${fileObj.name}`, 'user');
        setTimeout(() => {
            if (!fileObj.link || fileObj.link.startsWith("javascript:") || fileObj.link === "#") { 
                const htmlContent = `<div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div><div class="file-link-dummy"><span>âš ï¸</span><span>Link not configured</span></div>`; 
                addMessage(htmlContent, 'bot', true); 
            } else { 
                const htmlContent = `<div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div><a href="${fileObj.link}" target="_blank" class="file-link-btn"><span>ğŸ“‚</span><span>Download / Open File</span></a>`; 
                addMessage(htmlContent, 'bot', true); 
            }
        }, 800);
    }
    function goBack() {
        addMessage("ğŸ”™ Back", 'user');
        if (currentCategory) { currentCategory = null; const msg = replacePlaceholders(CONFIG.backDoctor, currentDoctor); botReply(msg, true); } else if (currentDoctor) { currentDoctor = null; const msg = replacePlaceholders(CONFIG.backSubject, currentSubject); botReply(msg, true); } else if (currentSubject) { currentSubject = null; botReply(CONFIG.backMain, true); }
        renderKeyboard();
    }

    // --- Initialization ---
    window.onload = () => {
        if ('caches' in window) { caches.keys().then(function(names) { for (let name of names) caches.delete(name); }); }
        if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(function(registrations) { for(let registration of registrations) registration.unregister(); }); }
        fetchConfig();
        startSync();
        setTimeout(() => { const welcomeMsg = replacePlaceholders(CONFIG.welcomeMessage, null); botReply(welcomeMsg, true); renderKeyboard(); }, 500);
    };

</script>
</body>
</html>