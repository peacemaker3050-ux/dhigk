<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>University Library Bot (Notifications System)</title>
    
    <!-- === Firebase SDKs === -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* === Reset & Basic Settings === */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: #121212;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-color: #0f0f0f;
            --header-bg: #17212b;
            --chat-bg: #0e1621;
            --msg-in: #182533;
            --msg-out: #2b5278;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-color: #3390ec;
            --btn-bg: rgba(255, 255, 255, 0.05);
            --btn-hover: rgba(51, 144, 236, 0.15);
            --btn-border: rgba(255, 255, 255, 0.1);
            --file-dummy-bg: rgba(255, 85, 85, 0.1);
            --file-dummy-text: #ff8888;
            --menu-bg: #1d2938;
            --modal-bg: rgba(0, 0, 0, 0.95);
            --admin-tab-active: #3390ec;
            --admin-tab-inactive: #2b2b2b;
            --danger-color: #ff4444;
            --owner-color: #ffd700; /* Gold for owner */
            --admin-color: #00e676; /* Green for helper admin */
            --notification-color: #ff9800; /* Orange for notifications */
            --broadcast-color: #ffd700; /* Gold for batch rep */
        }

        * { box-sizing: border-box; outline: none; }

        /* === Main Container === */
        .app-container {
            width: 100%;
            max-width: 500px; 
            height: 100%; 
            margin: 0 auto;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* === Header === */
        header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #000;
            z-index: 20; flex-shrink: 0; user-select: none;
        }

        .header-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        
        .bot-avatar {
            width: 42px; height: 42px; border-radius: 50%;
            background-color: var(--accent-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; flex-shrink: 0;
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat; 
            border: 2px solid transparent; 
            color: #fff;
            text-align: center;
            overflow: hidden;
        }

        .bot-name h2 { font-size: 16px; margin: 0; font-weight: 600; line-height: 1.2; }
        .bot-status { font-size: 13px; color: var(--text-secondary); margin-top: 2px; display: block; }

        .header-actions { color: var(--text-secondary); font-size: 28px; line-height:1; padding: 5px 10px; cursor: pointer; user-select: none; }
        .header-actions:hover { color: #fff; }

        /* === Options Menu (Dropdown) === */
        .menu-dropdown {
            position: absolute; top: 60px; left: 10px; /* RTL adjusted */
            width: 260px; background-color: var(--menu-bg);
            border: 1px solid #000; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; flex-direction: column; z-index: 100;
            overflow: hidden; animation: fadeIn 0.2s ease;
        }
        .menu-dropdown.active { display: flex; }
        .menu-item { padding: 12px 15px; cursor: pointer; color: #fff; font-size: 14px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { background-color: rgba(255,255,255,0.1); }
        .menu-item.danger { color: #ff6b6b; }
        .menu-item.admin { color: #4dabf7; font-weight: bold; }
        .menu-item.refresh { color: #ffcc00; }
        .menu-item.notif-toggle { color: var(--notification-color); font-weight: bold; }
        
        .menu-item.google-auth { color: #fff; }
        .menu-item.google-auth.is-owner { color: var(--owner-color); font-weight: bold; }
        .menu-item.google-auth.is-admin { color: var(--admin-color); font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* === Admin Modal === */
        .admin-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg); backdrop-filter: blur(8px);
            z-index: 200; display: none; flex-direction: column;
            padding: 20px; overflow-y: auto;
        }
        .admin-modal.active { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .modal-title { font-size: 18px; font-weight: bold; color: #fff; }
        .close-modal { font-size: 28px; color: #ccc; cursor: pointer; line-height: 1; }
        .close-modal:hover { color: #fff; }

        /* Admin Tabs */
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px; background: var(--admin-tab-inactive); border: none;
            color: #aaa; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s;
            font-size: 11px; flex: 1; white-space: nowrap;
        }
        .tab-btn.active { background: var(--admin-tab-active); color: #fff; }
        .tab-btn.owner-only { border: 1px solid var(--owner-color); color: var(--owner-color); }
        .tab-btn.owner-only.active { background: var(--owner-color); color: #000; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
        .form-input, .form-textarea, .form-select {
            width: 100%; padding: 10px; background: rgba(255,255,255,0.08); border: 1px solid #444;
            border-radius: 6px; color: #fff; outline: none; font-family: inherit; transition: border 0.2s;
        }
        .form-select { background-color: #1d2938; cursor: pointer; }
        .form-textarea { height: 80px; resize: vertical; }
        .form-input:focus, .form-textarea:focus { border-color: var(--accent-color); background: rgba(255,255,255,0.12); }
        
        .admin-section-title {
            color: var(--accent-color); margin-top: 20px; margin-bottom: 10px;
            font-size: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .btn-save, .btn-send, .btn-delete {
            width: 100%; padding: 12px; background-color: var(--accent-color);
            color: #fff; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 20px; transition: background 0.2s;
        }
        .btn-save:hover, .btn-send:hover { background-color: #267fd3; }
        .btn-delete { background-color: var(--danger-color); margin-top: 5px; }
        .btn-delete:hover { background-color: #d32f2f; }

        .btn-small-remove {
            background: rgba(255, 68, 68, 0.2); color: #ff4444; border: none;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px;
        }
        .btn-small-remove:hover { background: #ff4444; color: #fff; }

        /* Data Management Styles */
        .data-path { font-size: 12px; color: #888; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .data-path span { cursor: pointer; }
        .data-path span:hover { text-decoration: underline; color: var(--accent-color); }
        
        .data-list { display: flex; flex-direction: column; gap: 8px; max-height: 45vh; overflow-y: auto; margin-bottom: 15px; }
        .data-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
        }
        .data-item:hover { background: rgba(255,255,255,0.1); }
        .data-name { cursor: pointer; flex: 1; font-weight: 500; word-break: break-all; }
        .data-actions { display: flex; gap: 5px; align-items: center; }
        .btn-sm { padding: 4px 8px; border-radius: 4px; border: none; font-size: 11px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 3px;}
        .btn-del { background: rgba(255, 68, 68, 0.2); color: var(--danger-color); }
        .btn-del:hover { background: var(--danger-color); color: #fff; }
        .btn-edit { background: rgba(51, 144, 236, 0.2); color: var(--accent-color); }
        .btn-edit:hover { background: var(--accent-color); color: #fff; }

        /* Admin List Styles */
        .admin-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .admin-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05); font-size: 13px;
        }
        .admin-name { flex: 1; word-break: break-all; }
        .btn-remove {
            background: rgba(255, 68, 68, 0.2); color: #ff4444; border: none;
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        .btn-remove:hover { background: #ff4444; color: #fff; }

        .add-box { background: rgba(51, 144, 236, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(51, 144, 236, 0.3); }
        .add-row { display: flex; gap: 5px; margin-top: 8px; }
        .btn-add { background: #28a745; color: #fff; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; }
        .btn-add:hover { background: #218838; }

        /* === Chat Area === */
        #chat-area {
            flex: 1; padding: 15px; overflow-y: auto; display: flex;
            flex-direction: column; gap: 12px;
            background-color: var(--chat-bg);
            background-size: 20px 20px;
            scroll-behavior: smooth;
            transition: background-image 0.3s ease;
            background-repeat: no-repeat;
            background-position: center 70px;
            background-attachment: fixed; 
        }
        #chat-area.has-bg { background-size: contain !important; }
        #chat-area::-webkit-scrollbar { width: 5px; }
        #chat-area::-webkit-scrollbar-track { background: transparent; }
        #chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* === Messages === */
        .message {
            width: fit-content; max-width: 90%; padding: 10px 14px;
            border-radius: 18px; position: relative; font-size: 15px;
            line-height: 1.5; word-wrap: break-word;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .msg-bot { align-self: flex-start; background-color: var(--msg-in); color: var(--text-primary); border-bottom-left-radius: 4px; } 
        .msg-user { align-self: flex-end; background-color: var(--msg-out); color: var(--text-primary); border-bottom-right-radius: 4px; } 
        .msg-bot b { color: #fff; font-weight: 700; }
        .timestamp { font-size: 10px; color: rgba(255,255,255,0.4); text-align: right; display: block; margin-top: 6px; margin-bottom: 0; float: none; clear: both; user-select: none; }

        /* === Broadcast Message Style === */
        .broadcast-msg {
            background: linear-gradient(135deg, #332d00 0%, #4a3d00 100%);
            border: 1px solid var(--broadcast-color);
            border-right: 4px solid var(--broadcast-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15);
        }
        .broadcast-header {
            display: flex; align-items: center; gap: 8px; color: var(--broadcast-color); font-weight: bold; margin-bottom: 8px; font-size: 14px;
        }

        /* === File Attachments === */
        .file-link-btn {
            display: flex; align-items: center; gap: 10px;
            background-color: rgba(0,0,0,0.2); padding: 10px;
            border-radius: 8px; text-decoration: none; color: var(--accent-color);
            margin-top: 5px; border: 1px solid rgba(51, 144, 236, 0.3);
            font-size: 14px; cursor: pointer; transition: background 0.2s; overflow-wrap: break-word;
        }
        .file-link-btn:hover { background-color: rgba(51, 144, 236, 0.15); }
        .file-link-dummy {
            display: flex; align-items: center; gap: 10px;
            background-color: var(--file-dummy-bg); padding: 10px;
            border-radius: 8px; color: var(--file-dummy-text);
            margin-top: 5px; border: 1px solid rgba(255, 85, 85, 0.3);
            font-size: 14px;
        }
        /* Notification specific styling in chat */
        .notif-display {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-left: 4px solid var(--notification-color);
            padding: 12px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .notif-header {
            display: flex; justify-content: space-between; font-size: 11px; color: var(--notification-color); margin-bottom: 5px; font-weight: bold;
        }

        /* === Typing Indicator === */
        .typing-indicator { font-size: 12px; color: var(--text-secondary); margin-right: 15px; margin-bottom: 10px; display: none; font-style: italic; opacity: 0.8; flex-shrink: 0; } 
        .typing-indicator.active { display: block; }

        /* === Keyboard Area === */
        #keyboard-area {
            background-color: var(--header-bg); padding: 10px;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
            border-top: 1px solid #000; min-height: 0; max-height: 45vh;
            overflow-y: auto; flex-shrink: 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .keyboard-btn {
            background-color: var(--btn-bg); border: 1px solid var(--btn-border);
            color: var(--text-primary); padding: 12px 8px; border-radius: 10px;
            cursor: pointer; transition: all 0.15s ease; font-size: 14px;
            user-select: none; white-space: normal; word-wrap: break-word;
            word-break: break-word; text-align: center; line-height: 1.3;
            position: relative; overflow: hidden; min-height: 50px;
            display: flex; align-items: center; justify-content: center; font-weight: 500;
        }
        .keyboard-btn:hover { background-color: var(--btn-hover); }
        .keyboard-btn:active { transform: scale(0.96); background-color: rgba(255,255,255,0.15); }
        .keyboard-btn.back-btn {
            grid-column: span 2; background-color: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.05); color: var(--text-secondary); font-weight: bold;
        }
        @media (max-width: 480px) { .keyboard-btn { font-size: 13px; padding: 12px 6px; line-height: 1.4; min-height: 48px; } }
        @media (max-width: 350px) { #keyboard-area { grid-template-columns: 1fr; } .keyboard-btn.back-btn { grid-column: span 1; } }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-actions" id="menu-btn" title="Menu">â‹®</div>
        <div class="header-info">
            <div class="bot-name">
                <h2 id="header-name">University Bot</h2>
                <span class="bot-status" id="header-status">Online</span>
            </div>
            <div class="bot-avatar" id="header-avatar">ğŸ“</div>
        </div>

        <div class="menu-dropdown" id="menu-dropdown">
            <!-- NEW: Enable Notifications Button -->
            <div class="menu-item notif-toggle" onclick="window.enableNotifications()">
                <span>ğŸ””</span> <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
            </div>

            <div class="menu-item google-auth" id="google-login-btn" onclick="window.toggleGoogleLogin()">
                <span>ğŸ”‘</span> <span id="google-login-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</span>
            </div>
            
            <div class="menu-item admin" onclick="window.checkAdmin()">
                <span>âš™ï¸</span> <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin)</span>
            </div>
            <div class="menu-item refresh" onclick="window.forceReload()">
                <span>ğŸ”„</span> <span>ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ø±ÙŠ (Fix Cache)</span>
            </div>
            <div class="menu-item" onclick="window.clearChat()">
                <span>ğŸ—‘ï¸</span> <span>Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª</span>
            </div>
            <div class="menu-item danger" onclick="window.resetBot()">
                <span>ğŸ </span> <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
            </div>
        </div>
    </header>

    <div id="chat-area"></div>
    <div class="typing-indicator" id="typing">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
    <div id="keyboard-area"></div>
</div>

<!-- Admin Modal -->
<div class="admin-modal" id="admin-modal">
    <div class="modal-header">
        <div class="modal-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª</div>
        <div class="close-modal" onclick="window.closeAdminPanel()">Ã—</div>
    </div>

    <!-- Tabs Navigation -->
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="window.switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="tab-btn" onclick="window.switchTab('notifications')">ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙƒØªÙˆØ±</button>
        <button class="tab-btn" onclick="window.switchTab('broadcast')">ğŸ“£ Ø¥Ø°Ø§Ø¹Ø© Ø¹Ø§Ù…Ø©</button>
        <button class="tab-btn" onclick="window.switchTab('data')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <!-- Tab 1: General Settings -->
    <div id="tab-settings" class="tab-content active">
        <div class="admin-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        <div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª</label><input type="text" id="admin-bot-name" class="form-input"></div>
        <div class="form-group"><label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><input type="text" id="admin-bot-status" class="form-input"></div>
        
        <div class="form-group">
            <label class="form-label">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¨ÙˆØª (Ø±ÙØ¹ ØµÙˆØ±Ø©)</label>
            <input type="file" id="admin-icon-upload" accept="image/*" style="color: #aaa; font-size: 12px; background: rgba(0,0,0,0.2); padding: 5px;">
            <button class="btn-small-remove" id="admin-icon-remove" onclick="window.removeBotIcon()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
        </div>

        <div class="form-group">
            <label class="form-label">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Øª (Ø±ÙØ¹ ØµÙˆØ±Ø©)</label>
            <input type="file" id="admin-bg-upload" accept="image/*" style="color: #aaa; font-size: 12px; background: rgba(0,0,0,0.2); padding: 5px;">
            <button class="btn-small-remove" id="admin-bg-remove" onclick="window.removeChatBg()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
        </div>

        <div class="form-group"><label class="form-label">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨</label><textarea id="admin-msg-welcome" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø©</label><textarea id="admin-msg-subject" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙƒØªÙˆØ±</label><textarea id="admin-msg-doctor" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†Øµ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</label><textarea id="admin-msg-category" class="form-textarea"></textarea></div>
        <div class="form-group"><label class="form-label">Ù†ØµÙˆØµ Ø§Ù„Ø¹ÙˆØ¯Ø© (Back)</label><textarea id="admin-msg-backs" class="form-textarea" placeholder="Back Subject | Back Doctor | Back Main"></textarea></div>

        <!-- RESTRICTED SECTION: ONLY OWNER -->
        <div id="owner-admin-section" style="display: none;">
            <div class="admin-section-title" style="color: var(--owner-color);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)</div>
            <div class="form-group">
                <label class="form-label">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù (Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="email" id="admin-add-input" class="form-input" placeholder="admin@example.com">
                    <button class="btn-save" style="width: auto; margin: 0; padding: 0 15px;" onclick="window.addAdmin()">+</button>
                </div>
            </div>
            <div class="admin-list" id="admin-list-container"></div>
        </div>

        <button class="btn-save" onclick="window.saveAdminSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <!-- Tab 2: Send Notifications (Doctor Specific) -->
    <div id="tab-notifications" class="tab-content">
        <div class="admin-section-title" style="color: var(--notification-color);">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ (Ø¯ÙƒØªÙˆØ±)</div>
        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:15px;">
            Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ù‚Ø³Ù… "ğŸ”” Notifications" Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø±.
        </p>

        <div class="form-group">
            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
            <select id="notif-subject-select" class="form-select" onchange="window.populateNotifDoctors()"></select>
        </div>

        <div class="form-group">
            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±</label>
            <select id="notif-doctor-select" class="form-select" onchange="window.loadNotifPreview()"></select>
        </div>

        <div class="form-group">
            <label class="form-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <textarea id="notif-message-text" class="form-textarea" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ù‡Ù†Ø§..."></textarea>
        </div>

        <button class="btn-send" onclick="window.sendDoctorNotification()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
    </div>

    <!-- Tab 3: General Broadcast (Owner Only) -->
    <div id="tab-broadcast" class="tab-content">
        <div class="admin-section-title" style="color: var(--broadcast-color);">Ø¥Ø°Ø§Ø¹Ø© Ø¹Ø§Ù…Ø© (Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø¯ÙØ¹Ø©)</div>
        <div style="background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 6px; border: 1px solid var(--broadcast-color); margin-bottom: 15px;">
            <p style="font-size:12px; color:#ddd;">
                Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø³ØªØ¸Ù‡Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Øª ÙƒØ±Ø³Ø§Ù„Ø© Ù…Ù…ÙŠØ²Ø©ØŒ ÙˆØ³ØµØ¯Ø± Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù‡Ù….
            </p>
        </div>

        <div class="form-group">
            <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <input type="text" id="broadcast-title" class="form-input" placeholder="Ù…Ø«Ø§Ù„: ØªØºÙŠÙŠØ± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª">
        </div>

        <div class="form-group">
            <label class="form-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <textarea id="broadcast-body" class="form-textarea" style="height: 100px;" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."></textarea>
        </div>

        <button class="btn-save" style="background-color: var(--broadcast-color); color: #000;" onclick="window.saveBroadcast()">Ù†Ø´Ø± Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©</button>
        <button class="btn-delete" onclick="window.deleteBroadcast()">Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        
        <div id="broadcast-preview" style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
            <!-- Preview logic -->
        </div>
    </div>

    <!-- Tab 4: Data Management -->
    <div id="tab-data" class="tab-content">
        <div class="data-path" id="admin-data-path">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        
        <div id="admin-data-view-container">
            <div class="data-list" id="admin-list-items"></div>
            
            <div class="add-box" id="admin-add-box">
                <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</div>
                <div class="form-group" style="margin-bottom:5px;">
                    <input type="text" id="new-item-name" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù…...">
                </div>
                <div class="form-group" style="margin-bottom:0;" id="file-link-input-group" style="display:none;">
                    <input type="text" id="new-item-link" class="form-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù (Link)...">
                </div>
                <div class="add-row">
                    <button class="btn-save" style="margin-top:5px; padding:8px;" onclick="window.addAdminDataItem()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // === 0. SERVICE WORKER CODE (Background Notifications) ===
    // ============================================================
    const swCode = `
        const CACHE_VERSION = 'v2';
        const BIN_ID = "696e77bfae596e708fe71e9d";
        const BIN_KEY = "$2a$10$TunKuA35QdJp478eIMXxRunQfqgmhDY3YAxBXUXuV/JrgIFhU0Lf2";

        let lastNotifTime = 0;
        let lastBroadcastTime = 0;
        let fetchInterval;

        self.addEventListener('install', event => {
            self.skipWaiting();
        });

        self.addEventListener('activate', event => {
            event.waitUntil(self.clients.claim());
        });

        function checkNotifications() {
            fetch('https://api.jsonbin.io/v3/b/'+BIN_ID+'/latest', {
                headers: { 'X-Master-Key': BIN_KEY, 'X-Bin-Meta': 'false' }
            })
            .then(res => res.json())
            .then(data => {
                // Check Doctor Notifications
                if (data.latestNotificationUpdate && data.latestNotificationUpdate > lastNotifTime) {
                    lastNotifTime = data.latestNotificationUpdate;
                    if (Notification.permission === 'granted') {
                        self.registration.showNotification('ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¯ÙƒØªÙˆØ±', {
                            body: 'Ø§Ø¶ØºØ· Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„',
                            icon: 'https://cdn-icons-png.flaticon.com/512/2991/2991148.png',
                            requireInteraction: false
                        });
                    }
                }

                // Check General Broadcast
                if (data.generalBroadcast && data.generalBroadcast.active && data.generalBroadcast.timestamp > lastBroadcastTime) {
                    lastBroadcastTime = data.generalBroadcast.timestamp;
                    if (Notification.permission === 'granted') {
                        self.registration.showNotification('ğŸ“£ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø¯ÙØ¹Ø©', {
                            body: data.generalBroadcast.title + ': ' + data.generalBroadcast.body,
                            icon: 'https://cdn-icons-png.flaticon.com/512/1828/1828884.png',
                            requireInteraction: true
                        });
                    }
                }
            })
            .catch(err => console.error('SW Fetch Error:', err));
        }

        self.addEventListener('notificationclick', event => {
            event.notification.close();
            event.waitUntil(
                clients.matchAll({ type: 'window', includeUncontrolled: true }).then(clientList => {
                    for (const client of clientList) {
                        if (client.url === self.location.href && 'focus' in client) {
                            return client.focus();
                        }
                    }
                    if (clients.openWindow) {
                        return clients.openWindow(self.location.href);
                    }
                })
            );
        });

        self.addEventListener('activate', () => {
            fetchInterval = setInterval(checkNotifications, 60000); // Check every minute
            checkNotifications();
        });
    `;

    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(swBlob);

    // ============================================================
    // === 1. FIREBASE CONFIGURATION ===
    // ============================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBUzcbZDAFS3rhjcp2-maEiSTmuBmUlGPQ",
      authDomain: "libirary-b2424.firebaseapp.com",
      projectId: "libirary-b2424",
      storageBucket: "libirary-b2424.firebasestorage.app",
      messagingSenderId: "371129360013",
      appId: "1:371129360013:web:377ef70759204018a60cc4"
    };

    let auth;
    try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
    } catch (e) {
        console.error("Firebase Init Error", e);
    }

    const OWNER_EMAIL = "peacemaker3050@gmail.com";

    // ============================================================
    // === 2. CONFIGURATION & DEFAULTS ===
    // ============================================================
    const JSONBIN_BIN_ID = "696e77bfae596e708fe71e9d";
    const JSONBIN_ACCESS_KEY = "$2a$10$TunKuA35QdJp478eIMXxRunQfqgmhDY3YAxBXUXuV/JrgIFhU0Lf2";

    const defaultDatabase = {
        "Physics": {
            "doctors": ["Dr. Ahmed", "Dr. Mahmoud"],
            "Dr. Ahmed": {
                "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"],
                "ğŸ“š Lectures": [
                    { name: "Chapter 1: Mechanics Basics.pdf", link: "https://drive.google.com/file/d/1_iodAsHFokkB3rTyGls5hSGET9XuvtWM/view?usp=drivesdk" },
                    { name: "Chapter 2: Motion in One Dimension.pdf", link: "javascript:void(0)" }
                ],
                "ğŸ”” Notifications": []
            },
            "Dr. Mahmoud": {
                "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"],
                "ğŸ“š Lectures": [ { name: "Lecture 1: Thermodynamics Intro.pdf", link: "javascript:void(0)" } ],
                "ğŸ”” Notifications": []
            }
        },
        "Chemistry": {
            "doctors": ["Dr. Saeed", "Dr. Mona"],
            "Dr. Saeed": { "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"], "ğŸ“š Lectures": [], "ğŸ”” Notifications": [] },
            "Dr. Mona": { "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"], "ğŸ“š Lectures": [], "ğŸ”” Notifications": [] }
        },
        "Mathematics": {
            "doctors": ["Dr. Kamel", "Dr. Samy"],
            "Dr. Kamel": { "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"], "ğŸ“š Lectures": [], "ğŸ”” Notifications": [] },
            "Dr. Samy": { "sections": ["ğŸ“š Lectures", "ğŸ”” Notifications"], "ğŸ“š Lectures": [], "ğŸ”” Notifications": [] }
        }
    };

    const defaultConfig = {
        botName: "University Library",
        botStatus: "Online",
        botIcon: "ğŸ“", 
        botImage: "", 
        chatBgImage: "", 
        typingSpeed: 600, 
        admins: [], 
        latestNotificationUpdate: 0,
        generalBroadcast: { active: false, title: "", body: "", timestamp: 0 },
        welcomeMessage: "Welcome! ğŸ“<br>This is <b>{botName}</b>.<br>Please select a subject to begin.",
        subjectPrompt: "<b>{name}</b>\nPlease select a Doctor ğŸ‘‡",
        doctorPrompt: "<b>{name}</b>\nSelect a section ğŸ‘‡",
        categoryPrompt: "<b>{name}</b> list:",
        backSubject: "Back to <b>{name}</b> doctors:",
        backDoctor: "Back to <b>{name}</b> sections:",
        backMain: "Back to Main Menu.",
        database: defaultDatabase
    };

    let CONFIG = { ...defaultConfig };
    let database = CONFIG.database; 
    let refreshInterval = null;

    // ============================================================
    // === 3. AUTH LOGIC ===
    // ============================================================
    window.toggleGoogleLogin = function() {
        if (!auth) { alert("Firebase not configured correctly."); return; }
        const user = auth.currentUser;
        if (user) {
            auth.signOut().then(() => {
                console.log("User signed out.");
                window.location.reload(); // Reload to clear UI state
            }).catch((error) => console.error("Sign out error", error));
        } else {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                console.log("User signed in:", result.user);
                window.updateAuthUI();
            }).catch((error) => {
                console.error("Login error", error);
                alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
            });
        }
    };

    function initFirebaseAuth() {
        if (!auth) return;
        auth.onAuthStateChanged((user) => {
            window.updateAuthUI();
        });
    }

    window.updateAuthUI = function() {
        const loginBtn = document.getElementById('google-login-btn');
        const loginText = document.getElementById('google-login-text');
        const loginIcon = loginBtn.querySelector('span:first-child');
        const user = auth ? auth.currentUser : null;

        if (user) {
            const email = user.email;
            if (email === OWNER_EMAIL) {
                loginText.innerText = "ğŸ‘‘ Ø§Ù„Ù…Ø§Ù„Ùƒ (Owner)";
                loginBtn.classList.add('is-owner');
                loginBtn.classList.remove('is-admin');
                loginIcon.innerText = "ğŸ‘‘";
            } else if (CONFIG.admins && CONFIG.admins.includes(email)) {
                loginText.innerText = "ğŸ›¡ï¸ Ù…Ø³Ø§Ø¹Ø¯ (Admin)";
                loginBtn.classList.add('is-admin');
                loginBtn.classList.remove('is-owner');
                loginIcon.innerText = "ğŸ›¡ï¸";
            } else {
                loginText.innerText = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
                loginBtn.classList.remove('is-owner', 'is-admin');
                loginIcon.innerText = "âœ…";
            }
        } else {
            loginText.innerText = "ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Google)";
            loginBtn.classList.remove('is-owner', 'is-admin');
            loginIcon.innerText = "ğŸ”‘";
        }
    }

    // ============================================================
    // === 4. IMAGE COMPRESSOR ===
    // ============================================================
    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width; let height = img.height;
                const MAX_SIZE = 800; 
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                callback(dataUrl);
            };
            reader.onerror = (err) => { console.log(err); alert("Error processing image"); };
        };
    }

    // ============================================================
    // === 5. SYNC LOGIC ===
    // ============================================================
    function startSync() {
        if(refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(fetchConfig, 15000);
    }

    function stopSync() {
        if(refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
    }

    function fetchConfig() {
        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
            headers: { 'X-Master-Key': JSONBIN_ACCESS_KEY, 'X-Bin-Meta': 'false' }
        })
        .then(res => { if (!res.ok) throw new Error("Failed"); return res.json(); })
        .then(data => { 
            CONFIG = { ...defaultConfig, ...data }; 
            if (data.database) CONFIG.database = { ...data.database, ...defaultDatabase };
            else CONFIG.database = defaultDatabase;
            applyConfig(CONFIG); 
        })
        .catch(err => { console.error("Sync Error:", err); });
    }

    function saveConfigToBin(newConfig) {
        const btnSave = document.querySelector('.btn-save');
        const originalText = btnSave.innerText;
        if(btnSave) btnSave.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
        
        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_ACCESS_KEY },
            body: JSON.stringify(newConfig)
        })
        .then(res => { if (!res.ok) throw new Error("Save failed"); 
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
            database = newConfig.database;
            CONFIG.database = { ...newConfig.database, ...defaultDatabase };
            database = CONFIG.database;
            if(btnSave) btnSave.innerText = originalText;
        })
        .catch(err => { alert("âŒ Ø®Ø·Ø£: " + err.message); if(btnSave) btnSave.innerText = originalText; });
    }

    function applyConfig(newConfig) {
        CONFIG = newConfig;
        database = CONFIG.database; 
        document.getElementById('header-name').innerText = CONFIG.botName;
        document.getElementById('header-status').innerText = CONFIG.botStatus;

        const avatarEl = document.getElementById('header-avatar');
        if (CONFIG.botImage && CONFIG.botImage.trim().length > 10) {
            avatarEl.style.backgroundImage = `url('${CONFIG.botImage}')`; avatarEl.style.backgroundSize = "cover"; avatarEl.style.backgroundPosition = "center"; avatarEl.innerText = ""; 
        } else { avatarEl.style.backgroundImage = "none"; avatarEl.innerText = CONFIG.botIcon; }

        const chatArea = document.getElementById('chat-area');
        if (CONFIG.chatBgImage && CONFIG.chatBgImage.trim().length > 10) {
            chatArea.style.backgroundImage = `url('${CONFIG.chatBgImage}')`; chatArea.style.backgroundSize = "contain"; chatArea.style.backgroundColor = "transparent"; chatArea.classList.add('has-bg');
        } else { chatArea.style.backgroundImage = "none"; chatArea.style.backgroundColor = "var(--chat-bg)"; chatArea.style.backgroundSize = "20px 20px"; chatArea.classList.remove('has-bg'); }

        // Check Auth UI update on sync
        window.updateAuthUI();
        renderKeyboard();
        
        // Display Broadcast if active
        checkAndShowBroadcast();
    }

    function checkAndShowBroadcast() {
        // Remove existing broadcast message from DOM to avoid duplicates
        const existingBroadcast = document.getElementById('app-broadcast-msg');
        if (existingBroadcast) existingBroadcast.remove();

        if (CONFIG.generalBroadcast && CONFIG.generalBroadcast.active) {
            const localSeenTime = localStorage.getItem('lastSeenBroadcastTime') || 0;
            // Only show if new or forced (logic simplified: always show for now as per request emphasis, but check LS to hide if needed)
            // To allow users to dismiss it, we check localStorage.
            if (parseInt(CONFIG.generalBroadcast.timestamp) > parseInt(localSeenTime)) {
                const broadcastHTML = `
                    <div id="app-broadcast-msg" class="message msg-bot broadcast-msg">
                        <div class="broadcast-header">
                            <span>ğŸ“£</span> <span>Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø¯ÙØ¹Ø©</span>
                        </div>
                        <div><b>${CONFIG.generalBroadcast.title}</b></div>
                        <div style="margin-top:5px; font-size:14px; line-height:1.4;">${CONFIG.generalBroadcast.body}</div>
                        <span class="timestamp">${new Date(parseInt(CONFIG.generalBroadcast.timestamp)).toLocaleString()}</span>
                    </div>
                `;
                // Insert at top of chat (after welcome if welcome exists)
                const chatArea = document.getElementById('chat-area');
                chatArea.insertAdjacentHTML('afterbegin', broadcastHTML);
            }
        }
    }

    // Broadcast Interaction: When user clicks, mark as seen
    document.getElementById('chat-area').addEventListener('click', (e) => {
        const broadcastEl = document.getElementById('app-broadcast-msg');
        if (broadcastEl && broadcastEl.contains(e.target)) {
            if (CONFIG.generalBroadcast && CONFIG.generalBroadcast.timestamp) {
                localStorage.setItem('lastSeenBroadcastTime', CONFIG.generalBroadcast.timestamp);
            }
        }
    });

    function replacePlaceholders(text, name) {
        let res = text || "";
        if (name) res = res.replace(/{name}/g, name);
        res = res.replace(/{botName}/g, CONFIG.botName);
        return res;
    }

    // ============================================================
    // === 6. NOTIFICATION SYSTEM (ADMIN SIDE) ===
    // ============================================================
    
    // --- Helper: Check Access (Owner or Admin) ---
    function hasAdminAccess() {
        const user = auth.currentUser;
        if (!user) return false;
        const email = user.email;
        return email === OWNER_EMAIL || (CONFIG.admins && CONFIG.admins.includes(email));
    }

    // --- Doctor Notification ---
    window.populateNotifSubjects = function() {
        const select = document.getElementById('notif-subject-select');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>';
        const subjects = Object.keys(database);
        subjects.forEach(sub => {
            const opt = document.createElement('option'); opt.value = sub; opt.innerText = sub; select.appendChild(opt);
        });
    };

    window.populateNotifDoctors = function() {
        const subject = document.getElementById('notif-subject-select').value;
        const docSelect = document.getElementById('notif-doctor-select');
        docSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙƒØªÙˆØ± --</option>';
        
        if(subject && database[subject] && database[subject].doctors) {
            database[subject].doctors.forEach(doc => {
                const opt = document.createElement('option'); opt.value = doc; opt.innerText = doc; docSelect.appendChild(opt);
            });
        }
        window.loadNotifPreview();
    };

    window.sendDoctorNotification = function() {
        if (!hasAdminAccess()) return alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
        
        const subject = document.getElementById('notif-subject-select').value;
        const doctor = document.getElementById('notif-doctor-select').value;
        const message = document.getElementById('notif-message-text').value.trim();

        if(!subject || !doctor || !message) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

        const timestamp = new Date().toLocaleString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const fullDate = new Date().getTime();

        // Ensure Structure
        if (!database[subject][doctor].sections) database[subject][doctor].sections = [];
        if (!database[subject][doctor].sections.includes("ğŸ”” Notifications")) {
            database[subject][doctor].sections.unshift("ğŸ”” Notifications");
        }
        if (!database[subject][doctor]["ğŸ”” Notifications"]) database[subject][doctor]["ğŸ”” Notifications"] = [];

        // Add Notification Object with Unique ID
        database[subject][doctor]["ğŸ”” Notifications"].unshift({
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            name: message,
            date: timestamp,
            type: "notif",
            fullDate: fullDate
        });

        // Update Config
        CONFIG.latestNotificationUpdate = fullDate;
        CONFIG.database = database;
        
        const saveBtn = document.querySelector('#tab-notifications .btn-send');
        saveBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
        saveBtn.disabled = true;

        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_ACCESS_KEY },
            body: JSON.stringify(CONFIG)
        })
        .then(res => {
            if (!res.ok) throw new Error("Send failed");
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±!");
            document.getElementById('notif-message-text').value = "";
            saveBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±";
            saveBtn.disabled = false;
        })
        .catch(err => {
            alert("âŒ Ø®Ø·Ø£: " + err.message);
            saveBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±";
            saveBtn.disabled = false;
        });
    };

    window.loadNotifPreview = function() {
        // Placeholder if we want to show recent notifs in the tab later
    };

    // --- General Broadcast (Owner Only) ---
    window.saveBroadcast = function() {
        // Allow Owner OR Password User
        const user = auth.currentUser;
        const email = user ? user.email : null;
        const isOwner = email === OWNER_EMAIL;
        
        // Check if user is not owner, we prompt for password if not already checked in this session? 
        // For simplicity in this single page flow, we rely on the CheckAdmin gate to open the panel. 
        // But here we double check. Since the button is visible, let's add a password prompt if not owner.
        let allowed = isOwner;
        
        if (!allowed) {
            const pass = prompt("Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·. Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
            if (pass === "1234") allowed = true;
        }

        if (!allowed) return alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");

        const title = document.getElementById('broadcast-title').value.trim();
        const body = document.getElementById('broadcast-body').value.trim();

        if(!title || !body) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ");

        CONFIG.generalBroadcast = {
            active: true,
            title: title,
            body: body,
            timestamp: Date.now()
        };

        const saveBtn = document.querySelector('#tab-broadcast .btn-save');
        saveBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";

        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_ACCESS_KEY },
            body: JSON.stringify(CONFIG)
        })
        .then(res => {
            if (!res.ok) throw new Error("Save failed");
            alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©!");
            saveBtn.innerText = "Ù†Ø´Ø± Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©";
            checkAndShowBroadcast();
        })
        .catch(err => {
            alert("âŒ Ø®Ø·Ø£: " + err.message);
            saveBtn.innerText = "Ù†Ø´Ø± Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©";
        });
    };

    window.deleteBroadcast = function() {
         // Same Access Logic
        const user = auth.currentUser;
        const email = user ? user.email : null;
        const isOwner = email === OWNER_EMAIL;
        let allowed = isOwner;
        if (!allowed) {
            const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
            if (pass === "1234") allowed = true;
        }
        if (!allowed) return alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");

        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©ØŸ")) return;

        CONFIG.generalBroadcast = { active: false, title: "", body: "", timestamp: 0 };
        document.getElementById('broadcast-title').value = "";
        document.getElementById('broadcast-body').value = "";
        
        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_ACCESS_KEY },
            body: JSON.stringify(CONFIG)
        })
        .then(res => {
            if (!res.ok) throw new Error("Delete failed");
            alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù.");
            // Remove from DOM immediately
            const existing = document.getElementById('app-broadcast-msg');
            if(existing) existing.remove();
        })
        .catch(err => alert("âŒ Ø®Ø·Ø£: " + err.message));
    };


    // ============================================================
    // === 7. BOT LOGIC ===
    // ============================================================
    let currentSubject = null, currentDoctor = null, currentCategory = null;
    const chatArea = document.getElementById('chat-area');
    const keyboardArea = document.getElementById('keyboard-area');
    const typingIndicator = document.getElementById('typing');
    const menuBtn = document.getElementById('menu-btn');
    const menuDropdown = document.getElementById('menu-dropdown');
    
    const adminNameInput = document.getElementById('admin-bot-name');
    const adminStatusInput = document.getElementById('admin-bot-status');
    const adminIconUpload = document.getElementById('admin-icon-upload');
    const adminIconRemove = document.getElementById('admin-icon-remove');
    const adminBgUpload = document.getElementById('admin-bg-upload');
    const adminBgRemove = document.getElementById('admin-bg-remove');
    const adminAddInput = document.getElementById('admin-add-input');
    const adminListContainer = document.getElementById('admin-list-container');
    const respWelcome = document.getElementById('admin-msg-welcome');
    const respSubject = document.getElementById('admin-msg-subject');
    const respDoctor = document.getElementById('admin-msg-doctor');
    const respCategory = document.getElementById('admin-msg-category');
    const respBacks = document.getElementById('admin-msg-backs');

    function addMessage(content, sender, isHtml = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender === 'bot' ? 'msg-bot' : 'msg-user');
        if (isHtml) msgDiv.innerHTML = content; else msgDiv.innerText = content;
        const timeSpan = document.createElement('span');
        timeSpan.classList.add('timestamp');
        timeSpan.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        msgDiv.appendChild(timeSpan);
        chatArea.appendChild(msgDiv);
        scrollToBottom();
    }

    function scrollToBottom() { setTimeout(() => { chatArea.scrollTop = chatArea.scrollHeight; }, 0); }
    function botReply(text, isHtml = false) {
        typingIndicator.classList.add('active'); scrollToBottom();
        setTimeout(() => { typingIndicator.classList.remove('active'); addMessage(text, 'bot', isHtml); }, CONFIG.typingSpeed);
    }

    function createButton(text, onClick, isBack = false) {
        const btn = document.createElement('div');
        btn.classList.add('keyboard-btn'); if(isBack) btn.classList.add('back-btn');
        btn.innerText = text; btn.onclick = onClick; return btn;
    }

    menuBtn.addEventListener('click', (e) => { e.stopPropagation(); menuDropdown.classList.toggle('active'); });
    document.addEventListener('click', (e) => { if (!menuDropdown.contains(e.target) && e.target !== menuBtn) menuDropdown.classList.remove('active'); });

    window.clearChat = function() {
        chatArea.innerHTML = ''; 
        // We don't clear the broadcast from localStorage, user just clears chat view
        resetStateVariables(); menuDropdown.classList.remove('active');
        setTimeout(() => { botReply("Chat cleared. ğŸ§¹<br>Welcome back! Choose a subject ğŸ‘‡", true); }, 100);
    }
    window.resetBot = function() {
        resetStateVariables(); menuDropdown.classList.remove('active');
        addMessage("ğŸ  Back to Main Menu", 'user'); botReply("Bot restarted. Please select a subject ğŸ‘‡", true);
    }

    // Enable Notifications
    window.enableNotifications = function() {
        menuDropdown.classList.remove('active');
        if (!('Notification' in window)) {
            alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.");
            return;
        }
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                new Notification("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„", { body: "Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© ÙˆØ§Ù„Ø¥Ø°Ø§Ø¹Ø§Øª Ø§Ù„Ø¢Ù†." });
            } else {
                alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.");
            }
        });
    };

    window.checkAdmin = function() {
        menuDropdown.classList.remove('active');
        if (auth && auth.currentUser) {
            const email = auth.currentUser.email;
            if (email === OWNER_EMAIL || (CONFIG.admins && CONFIG.admins.includes(email))) {
                openAdminPanel();
                return;
            }
            alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ø¯Ø®ÙˆÙ„.\nØ£Ù†Øª Ù…Ø³Ø¬Ù„ ÙƒÙ€: " + email);
            return;
        }
        const password = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
        if (password === "1234") openAdminPanel();
        else if (password !== null) alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
    }

    window.forceReload = function() {
        document.getElementById('menu-dropdown').classList.remove('active');
        if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.")) {
            if ('caches' in window) { caches.keys().then(function(names) { for (let name of names) caches.delete(name); }); }
            if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(function(registrations) { for(let registration of registrations) registration.unregister(); }); }
            window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
        }
    };

    // ============================================================
    // === 8. ADMIN PANEL LOGIC ===
    // ============================================================
    let adminNavStack = [];

    function openAdminPanel() {
        stopSync();
        adminNameInput.value = CONFIG.botName; adminStatusInput.value = CONFIG.botStatus;
        
        adminIconUpload.value = ""; 
        if(CONFIG.botImage) adminIconRemove.style.display = 'inline-block'; else adminIconRemove.style.display = 'none';

        adminBgUpload.value = ""; 
        if(CONFIG.chatBgImage) adminBgRemove.style.display = 'inline-block'; else adminBgRemove.style.display = 'none';

        respWelcome.value = CONFIG.welcomeMessage; respSubject.value = CONFIG.subjectPrompt; 
        respDoctor.value = CONFIG.doctorPrompt; respCategory.value = CONFIG.categoryPrompt;
        const backs = [CONFIG.backSubject, CONFIG.backDoctor, CONFIG.backMain];
        respBacks.value = backs.join(' | ');

        const ownerSection = document.getElementById('owner-admin-section');
        if (auth && auth.currentUser && auth.currentUser.email === OWNER_EMAIL) {
            ownerSection.style.display = 'block'; renderAdminList();
        } else { ownerSection.style.display = 'none'; }

        // Broadcast Init
        if(CONFIG.generalBroadcast && CONFIG.generalBroadcast.active) {
            document.getElementById('broadcast-title').value = CONFIG.generalBroadcast.title;
            document.getElementById('broadcast-body').value = CONFIG.generalBroadcast.body;
        } else {
            document.getElementById('broadcast-title').value = "";
            document.getElementById('broadcast-body').value = "";
        }

        window.populateNotifSubjects(); 
        
        renderAdminDataView(); 
        document.getElementById('admin-modal').classList.add('active');
    }

    window.closeAdminPanel = function() { 
        document.getElementById('admin-modal').classList.remove('active'); 
        startSync(); fetchConfig();
    }

    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if(tabName === 'settings') {
            document.querySelector('button[onclick="window.switchTab(\'settings\')"]').classList.add('active');
            document.getElementById('tab-settings').classList.add('active');
        } else if (tabName === 'notifications') {
            document.querySelector('button[onclick="window.switchTab(\'notifications\')"]').classList.add('active');
            document.getElementById('tab-notifications').classList.add('active');
            window.populateNotifSubjects();
        } else if (tabName === 'broadcast') {
            // Check Owner Access strictly for Tab
            const user = auth.currentUser;
            const isOwner = user && user.email === OWNER_EMAIL;
            // If not owner, check if we just entered via password (simplified: allow entry, but check inside save)
            document.querySelector('button[onclick="window.switchTab(\'broadcast\')"]').classList.add('active');
            document.getElementById('tab-broadcast').classList.add('active');
        } else {
            document.querySelector('button[onclick="window.switchTab(\'data\')"]').classList.add('active');
            document.getElementById('tab-data').classList.add('active');
            renderAdminDataView();
        }
    }

    adminIconUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) { compressImage(file, (base64String) => { CONFIG.botImage = base64String; applyConfig(CONFIG); adminIconRemove.style.display = 'inline-block'; }); }
    });
    window.removeBotIcon = function() { CONFIG.botImage = ""; applyConfig(CONFIG); adminIconUpload.value = ""; adminIconRemove.style.display = 'none'; };

    adminBgUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) { compressImage(file, (base64String) => { CONFIG.chatBgImage = base64String; applyConfig(CONFIG); adminBgRemove.style.display = 'inline-block'; }); }
    });
    window.removeChatBg = function() { CONFIG.chatBgImage = ""; applyConfig(CONFIG); adminBgUpload.value = ""; adminBgRemove.style.display = 'none'; };

    function renderAdminList() {
        adminListContainer.innerHTML = '';
        if (!CONFIG.admins || CONFIG.admins.length === 0) { adminListContainer.innerHTML = '<div style="color:#777; font-size:13px; text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† Ù…Ø¶Ø§ÙÙŠÙ†</div>'; return; }
        CONFIG.admins.forEach((adminEmail, index) => {
            const div = document.createElement('div'); div.className = 'admin-item';
            const nameSpan = document.createElement('span'); nameSpan.className = 'admin-name'; nameSpan.innerText = adminEmail;
            const removeBtn = document.createElement('button'); removeBtn.className = 'btn-remove'; removeBtn.innerText = 'Ø­Ø°Ù'; removeBtn.onclick = () => removeAdmin(index);
            div.appendChild(nameSpan); div.appendChild(removeBtn); adminListContainer.appendChild(div);
        });
    }
    window.addAdmin = function() {
        const email = adminAddInput.value.trim();
        if (email && (!CONFIG.admins.includes(email))) { 
            if (!email.includes('@')) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­");
            CONFIG.admins.push(email); adminAddInput.value = ''; renderAdminList(); 
        } else if (email) alert("Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„!");
    }
    window.removeAdmin = function(index) { 
        if (!auth || !auth.currentUser || auth.currentUser.email !== OWNER_EMAIL) { alert("â›” ÙÙ‚Ø· Ø§Ù„Ù…Ø§Ù„Ùƒ ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†."); return; }
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙØŸ")) { CONFIG.admins.splice(index, 1); renderAdminList(); } 
    }

    window.saveAdminSettings = function() {
        const backsArr = respBacks.value.split('|').map(s => s.trim());
        const newConfig = {
            botName: adminNameInput.value.trim() || defaultConfig.botName,
            botStatus: adminStatusInput.value.trim() || defaultConfig.botStatus,
            botImage: CONFIG.botImage,
            chatBgImage: CONFIG.chatBgImage,
            welcomeMessage: respWelcome.value, subjectPrompt: respSubject.value,
            doctorPrompt: respDoctor.value, categoryPrompt: respCategory.value,
            backSubject: backsArr[0] || CONFIG.backSubject,
            backDoctor: backsArr[1] || CONFIG.backDoctor,
            backMain: backsArr[2] || CONFIG.backMain,
            admins: CONFIG.admins,
            // Preserve other data
            generalBroadcast: CONFIG.generalBroadcast,
            latestNotificationUpdate: CONFIG.latestNotificationUpdate,
            lastNotifSubject: CONFIG.lastNotifSubject,
            lastNotifDoctor: CONFIG.lastNotifDoctor,
            database: database 
        };
        CONFIG = { ...CONFIG, ...newConfig }; applyConfig(CONFIG); saveConfigToBin(newConfig);
    }

    // === DATA MANAGEMENT LOGIC (With Edit/Delete for Notifications) ===
    function renderAdminDataView() {
        const pathContainer = document.getElementById('admin-data-path');
        const listContainer = document.getElementById('admin-list-items');
        const addBoxNameInput = document.getElementById('new-item-name');
        const addBoxLinkGroup = document.getElementById('file-link-input-group');
        const addBoxLinkInput = document.getElementById('new-item-link');

        listContainer.innerHTML = ''; addBoxNameInput.value = ''; addBoxLinkInput.value = '';
        addBoxNameInput.placeholder = "Ø§Ù„Ø§Ø³Ù…...";

        let pathHTML = `<span onclick="window.adminNavTo(-1)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;
        if (adminNavStack.length > 0) pathHTML += ` > <span onclick="window.adminNavTo(0)">${adminNavStack[0]}</span>`;
        if (adminNavStack.length > 1) pathHTML += ` > <span onclick="window.adminNavTo(1)">${adminNavStack[1]}</span>`;
        if (adminNavStack.length > 2) pathHTML += ` > <span>${adminNavStack[2]}</span>`;
        pathContainer.innerHTML = pathHTML;

        let level = adminNavStack.length;
        let dataList = [];
        
        // Check if we are in a notifications folder
        let isNotificationsFolder = false;
        if (level === 3 && adminNavStack[2] === "ğŸ”” Notifications") {
            isNotificationsFolder = true;
        }

        if (level === 0) {
            dataList = Object.keys(database);
            addBoxLinkGroup.style.display = 'none';
        } else if (level === 1) {
            const subName = adminNavStack[0];
            if (database[subName] && database[subName].doctors) dataList = database[subName].doctors;
            addBoxLinkGroup.style.display = 'none';
        } else if (level === 2) {
            const subName = adminNavStack[0]; const docName = adminNavStack[1];
            if (database[subName] && database[subName][docName] && database[subName][docName].sections) dataList = database[subName][docName].sections;
            addBoxLinkGroup.style.display = 'none';
        } else if (level === 3) {
            const subName = adminNavStack[0]; const docName = adminNavStack[1]; const secName = adminNavStack[2];
            if (database[subName] && database[subName][docName] && database[subName][docName][secName]) dataList = database[subName][docName][secName];
            
            // Notifications are special (Text only), others are files (Name + Link)
            if (!isNotificationsFolder) {
                addBoxLinkGroup.style.display = 'block'; 
                addBoxNameInput.placeholder = "Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù...";
            } else {
                addBoxLinkGroup.style.display = 'none';
                addBoxNameInput.placeholder = "Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±...";
            }
        }

        if (dataList.length === 0) { listContainer.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</div>'; }
        else {
            dataList.forEach((item, index) => {
                const itemName = (typeof item === 'object') ? item.name : item;
                const div = document.createElement('div'); div.className = 'data-item';
                const nameSpan = document.createElement('div'); nameSpan.className = 'data-name'; nameSpan.innerText = itemName;
                
                // Drill down logic
                if (level < 3) nameSpan.onclick = () => { adminNavStack.push(itemName); renderAdminDataView(); };

                const actionsDiv = document.createElement('div'); actionsDiv.className = 'data-actions';
                
                // DELETE BUTTON
                const delBtn = document.createElement('button'); delBtn.className = 'btn-sm btn-del'; delBtn.innerText = 'ğŸ—‘ï¸'; 
                delBtn.onclick = () => deleteAdminDataItem(index);
                actionsDiv.appendChild(delBtn);

                // EDIT BUTTON (Only for Notifications)
                if (isNotificationsFolder && (typeof item === 'object') && item.id) {
                    const editBtn = document.createElement('button'); editBtn.className = 'btn-sm btn-edit'; editBtn.innerText = 'âœï¸';
                    editBtn.onclick = () => editNotification(index);
                    actionsDiv.appendChild(editBtn);
                }

                div.appendChild(nameSpan); div.appendChild(actionsDiv); listContainer.appendChild(div);
            });
        }
    }

    window.adminNavTo = function(index) {
        if (index === -1) adminNavStack = []; else adminNavStack = adminNavStack.slice(0, index + 1);
        renderAdminDataView();
    }

    // --- Editing Notification Logic ---
    window.editNotification = function(index) {
        const sub = adminNavStack[0]; const doc = adminNavStack[1]; const sec = adminNavStack[2];
        const list = database[sub][doc][sec];
        const item = list[index];

        const newText = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", item.name);
        if (newText !== null && newText.trim() !== "") {
            item.name = newText.trim();
            item.date = new Date().toLocaleString('en-US', { weekday: 'short', hour: '2-digit', minute:'2-digit' }) + " (Ù…Ø¹Ø¯Ù„)";
            renderAdminDataView();
            // Note: Saving happens when main Save button is clicked or we could save here. 
            // Better to force save to update the DB immediately for users.
            alert("âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.");
        }
    }

    window.addAdminDataItem = function() {
        const nameInput = document.getElementById('new-item-name'); const linkInput = document.getElementById('new-item-link');
        const name = nameInput.value.trim(); let level = adminNavStack.length;
        if (!name) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");

        // Check Admin Access for sensitive areas? 
        // For simplicity, anyone who can open Admin Panel (Pass/Owner) can edit data.
        
        if (level === 0) { 
            if (database[name]) return alert("Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!"); 
            database[name] = { doctors: [] }; 
        } 
        else if (level === 1) {
            const sub = adminNavStack[0]; 
            if (!database[sub]) database[sub] = { doctors: [] };
            if (database[sub].doctors.includes(name)) return alert("Ø§Ù„Ø¯ÙƒØªÙˆØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
            database[sub].doctors.push(name); 
            database[sub][name] = { sections: ["ğŸ“š Lectures", "ğŸ”” Notifications"] }; // Default add notifs
            database[sub][name]["ğŸ“š Lectures"] = [];
            database[sub][name]["ğŸ”” Notifications"] = [];
        } 
        else if (level === 2) {
            const sub = adminNavStack[0]; const doc = adminNavStack[1];
            if (!database[sub][doc]) database[sub][doc] = { sections: [] };
            if (database[sub][doc].sections.includes(name)) return alert("Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
            database[sub][doc].sections.push(name); 
            database[sub][doc][name] = []; 
        } 
        else if (level === 3) {
            const sub = adminNavStack[0]; const doc = adminNavStack[1]; const sec = adminNavStack[2];
            
            if (sec === "ğŸ”” Notifications") {
                // Adding a Notification
                database[sub][doc][sec].unshift({
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    name: name,
                    date: new Date().toLocaleString(),
                    type: "notif"
                });
            } else {
                // Adding a File
                const link = linkInput.value.trim() || "#";
                if (!database[sub][doc][sec]) database[sub][doc][sec] = [];
                database[sub][doc][sec].push({ name: name, link: link });
            }
        }
        renderAdminDataView();
    }

    function deleteAdminDataItem(index) {
        let level = adminNavStack.length;
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
        
        if (level === 0) { 
            const subKeys = Object.keys(database); 
            delete database[subKeys[index]]; 
        } 
        else if (level === 1) { 
            const sub = adminNavStack[0]; 
            const docName = database[sub].doctors[index];
            database[sub].doctors.splice(index, 1); 
            delete database[sub][docName]; 
        }
        else if (level === 2) { 
            const sub = adminNavStack[0]; const doc = adminNavStack[1]; 
            const secName = database[sub][doc].sections[index];
            database[sub][doc].sections.splice(index, 1); 
            delete database[sub][doc][secName]; 
        }
        else if (level === 3) { 
            const sub = adminNavStack[0]; const doc = adminNavStack[1]; const sec = adminNavStack[2]; 
            database[sub][doc][sec].splice(index, 1); 
        }
        renderAdminDataView();
    }

    // ============================================================
    // === 9. KEYBOARD RENDERER ===
    // ============================================================
    function resetStateVariables() { currentSubject = null; currentDoctor = null; currentCategory = null; renderKeyboard(); }

    function renderKeyboard() {
        keyboardArea.innerHTML = '';
        const subjects = Object.keys(database);
        if (!currentSubject) { 
            subjects.forEach(sub => { keyboardArea.appendChild(createButton(sub, () => handleSubjectClick(sub))); }); 
            return; 
        }
        keyboardArea.appendChild(createButton("ğŸ”™ Back", goBack, true));
        if (currentSubject && !currentDoctor) {
            const subjectDoctors = database[currentSubject].doctors;
            subjectDoctors.forEach(doc => { keyboardArea.appendChild(createButton(doc, () => handleDoctorClick(doc))); });
        } else if (currentSubject && currentDoctor && !currentCategory) {
            const doctorSections = database[currentSubject][currentDoctor].sections;
            doctorSections.forEach(cat => { keyboardArea.appendChild(createButton(cat, () => handleCategoryClick(cat))); });
        } else if (currentSubject && currentDoctor && currentCategory) {
            const fileList = database[currentSubject][currentDoctor][currentCategory] || [];
            if (fileList.length > 0) { fileList.forEach(file => { keyboardArea.appendChild(createButton(file.name, () => handleFileClick(file))); }); } else {
                const emptyBtn = createButton("âŒ No files available", () => {}); emptyBtn.style.opacity = "0.5"; emptyBtn.style.cursor = "default"; keyboardArea.appendChild(emptyBtn);
            }
        }
    }

    function handleSubjectClick(subjectName) { addMessage(subjectName, 'user'); currentSubject = subjectName; currentDoctor = null; currentCategory = null; const msg = replacePlaceholders(CONFIG.subjectPrompt, subjectName); botReply(msg, true); renderKeyboard(); }
    function handleDoctorClick(doctorName) { addMessage(doctorName, 'user'); currentDoctor = doctorName; currentCategory = null; const msg = replacePlaceholders(CONFIG.doctorPrompt, doctorName); botReply(msg, true); renderKeyboard(); }
    function handleCategoryClick(categoryName) { addMessage(categoryName, 'user'); currentCategory = categoryName; const msg = replacePlaceholders(CONFIG.categoryPrompt, categoryName); botReply(msg, true); renderKeyboard(); }

    function handleFileClick(fileObj) {
        addMessage(`Open: ${fileObj.name}`, 'user');
        setTimeout(() => {
            if (!fileObj.link || fileObj.link.startsWith("javascript:") || fileObj.link === "#") { 
                const htmlContent = `<div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div><div class="file-link-dummy"><span>âš ï¸</span><span>Link not configured</span></div>`; 
                addMessage(htmlContent, 'bot', true); 
            } else { 
                // Check if it's a notification content (special handling)
                if (fileObj.type === "notif" || (fileObj.link && fileObj.link.startsWith("content:"))) {
                    const actualMsg = fileObj.type === "notif" ? fileObj.name : fileObj.link.replace("content:", "");
                    const htmlContent = `
                        <div class="notif-display">
                            <div class="notif-header">ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø¯ÙƒØªÙˆØ± â€¢ ${currentDoctor} (${currentSubject})</div>
                            <div>${actualMsg}</div>
                        </div>
                    `;
                    addMessage(htmlContent, 'bot', true);
                } else {
                    // Standard file
                    const htmlContent = `<div style="margin-bottom:5px;">ğŸ“ <b>${fileObj.name}</b></div><a href="${fileObj.link}" target="_blank" class="file-link-btn"><span>ğŸ“‚</span><span>Download / Open File</span></a>`; 
                    addMessage(htmlContent, 'bot', true); 
                }
            }
        }, 800);
    }
    
    function goBack() {
        addMessage("ğŸ”™ Back", 'user');
        if (currentCategory) { currentCategory = null; const msg = replacePlaceholders(CONFIG.backDoctor, currentDoctor); botReply(msg, true); } 
        else if (currentDoctor) { currentDoctor = null; const msg = replacePlaceholders(CONFIG.backSubject, currentSubject); botReply(msg, true); } 
        else if (currentSubject) { currentSubject = null; botReply(CONFIG.backMain, true); }
        renderKeyboard();
    }

    // --- Initialization ---
    window.onload = () => {
        if ('caches' in window) { caches.keys().then(function(names) { for (let name of names) caches.delete(name); }); }
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register(swUrl).catch(err => console.error("SW Fail:", err)); }
        
        initFirebaseAuth(); fetchConfig(); startSync();
        setTimeout(() => { 
            const welcomeMsg = replacePlaceholders(CONFIG.welcomeMessage, null); 
            // We add welcome slightly delayed to allow Broadcast to appear first if logic requires
            // But currently Broadcast is added via insertAdjacentHTML, so welcome goes after in flow
            botReply(welcomeMsg, true); 
            renderKeyboard(); 
        }, 500);
    };

</script>
</body>
</html>