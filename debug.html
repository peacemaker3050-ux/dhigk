<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Debugger</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #222; color: #fff; }
        .status { padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 5px solid #ccc; }
        .success { background: #1a4d1a; border-color: #4ade80; }
        .error { background: #4a1010; border-color: #f87171; }
        .warning { background: #4a3800; border-color: #fbbf24; }
        h1 { font-size: 24px; color: #60a5fa; }
        code { background: #333; padding: 5px; border-radius: 4px; color: #fbbf24; }
    </style>
</head>
<body>

    <h1>üõ†Ô∏è Diagnostics</h1>

    <div id="https-check" class="status">Checking HTTPS...</div>
    <div id="sw-support" class="status">Checking SW Support...</div>
    <div id="sw-registered" class="status">Checking Registration...</div>
    <div id="sw-controller" class="status">Checking Active Controller...</div>
    <div id="manifest-check" class="status">Checking Manifest...</div>

    <hr style="border-color: #555;">
    <p><b>Common Issues:</b></p>
    <ul>
        <li><b>Manifest Location:</b> Ensure <code>manifest.json</code> is in the ROOT folder with index.html.</li>
        <li><b>SW Location:</b> Ensure <code>sw.js</code> is in the ROOT folder with index.html.</li>
        <li><b>Reload:</b> If you just uploaded files, do a Hard Reload (Ctrl+F5) and clear cache.</li>
        <li><b>HTTPS:</b> Notifications only work on HTTPS (or localhost).</li>
    </ul>

    <button onclick="unregisterAndReload()" style="padding: 15px; background: #f87171; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Unregister SW & Reload</button>

    <script>
        // 1. Check HTTPS
        const isHttps = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        updateStatus('https-check', isHttps, 'Protocol is ' + location.protocol);

        // 2. Check SW Support
        const swSupport = 'serviceWorker' in navigator;
        updateStatus('sw-support', swSupport, swSupport ? 'Supported' : 'NOT Supported');

        if (!swSupport) {
            alert("Your browser does not support Service Workers. Notifications will not work.");
            return;
        }

        // 3. Check Registration
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                updateStatus('sw-registered', true, 'SW Registered (Scope: ' + reg.scope + ')');
                
                if (navigator.serviceWorker.controller) {
                    updateStatus('sw-controller', true, 'Active Controller Found: ' + navigator.serviceWorker.controller.scriptURL);
                } else {
                    updateStatus('sw-controller', false, 'No Active Controller (Page needs reload or SW is not in scope)');
                }

                // Check Manifest link
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    updateStatus('manifest-check', true, 'Manifest Found: ' + manifestLink.href);
                } else {
                    updateStatus('manifest-check', false, 'Manifest NOT Found in HTML!');
                }

            })
            .catch(err => {
                updateStatus('sw-registered', false, 'Registration Failed: ' + err.message);
            });

        function updateStatus(id, isGood, text) {
            const el = document.getElementById(id);
            el.className = 'status ' + (isGood ? 'success' : 'error');
            el.innerText = text;
        }

        function unregisterAndReload() {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
                window.location.reload();
            });
        }
    </script>
</body>
</html>